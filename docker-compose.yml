services:
  nginx:
    image: nginx:1.27-alpine
    container_name: relay-nginx
    depends_on:
      - webhook-relay
    ports:
      - "443:443"
    volumes:
      - ./deploy/nginx/webhook-relay.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs/tls.crt:/etc/nginx/certs/tls.crt:ro
      - ./certs/tls.key:/etc/nginx/certs/tls.key:ro
    restart: unless-stopped

  webhook-relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: webhook-relay
    environment:
      RELAY_BIND: "0.0.0.0:8080"
      RELAY_MAX_PAYLOAD_BYTES: "1048576"
      RELAY_IP_RATE_PER_MINUTE: "100"
      RELAY_SOURCE_RATE_PER_MINUTE: "500"
      RELAY_TRUST_PROXY_HEADERS: "${RELAY_TRUST_PROXY_HEADERS:-false}"
      RELAY_TRUSTED_PROXY_CIDRS: "${RELAY_TRUSTED_PROXY_CIDRS:-127.0.0.1/32,::1/128}"
      RELAY_DEDUP_TTL_SECONDS: "${RELAY_DEDUP_TTL_SECONDS:-604800}"
      RELAY_COOLDOWN_SECONDS: "${RELAY_COOLDOWN_SECONDS:-30}"
      RELAY_ENFORCE_LINEAR_TIMESTAMP_WINDOW: "${RELAY_ENFORCE_LINEAR_TIMESTAMP_WINDOW:-true}"
      RELAY_LINEAR_TIMESTAMP_WINDOW_SECONDS: "${RELAY_LINEAR_TIMESTAMP_WINDOW_SECONDS:-60}"
      KAFKA_BROKERS: "${KAFKA_BROKERS}"
      KAFKA_AUTO_CREATE_TOPICS: "${KAFKA_AUTO_CREATE_TOPICS:-true}"
      KAFKA_TOPIC_PARTITIONS: "${KAFKA_TOPIC_PARTITIONS:-3}"
      KAFKA_TOPIC_REPLICATION_FACTOR: "${KAFKA_TOPIC_REPLICATION_FACTOR:-1}"
      KAFKA_DLQ_TOPIC: "${KAFKA_DLQ_TOPIC:-webhooks.dlq}"
      KAFKA_TLS_CERT: "/etc/relay/certs/relay.crt"
      KAFKA_TLS_KEY: "/etc/relay/certs/relay.key"
      KAFKA_TLS_CA: "/etc/relay/certs/ca.crt"
      HMAC_SECRET_GITHUB: "${HMAC_SECRET_GITHUB}"
      HMAC_SECRET_LINEAR: "${HMAC_SECRET_LINEAR}"
      RUST_LOG: "info"
    expose:
      - "8080"
    volumes:
      - ./certs:/etc/relay/certs:ro
    restart: unless-stopped
