# kafka-openclaw-hook

Outbound-only Rust consumer that reads webhook envelopes from Kafka/AutoMQ and forwards them to OpenClaw.

## Purpose

- Subscribe to configured `webhooks.*` topics.
- Deserialize `relay_core::model::WebhookEnvelope`.
- Forward to OpenClaw `/hooks/agent` with retry/backoff.
- Publish exhausted failures to DLQ topic.
- Commit Kafka offset after processing path completes.

## Runtime Model

1. `consumer.rs` polls Kafka.
2. `forwarder.rs` builds OpenClaw payload and attempts HTTP POST.
3. If forwarding keeps failing, `dlq.rs` writes `relay_core::model::DlqEnvelope` to DLQ.
4. Message offset is committed asynchronously.

## Configuration

Required env vars:

- `KAFKA_BROKERS`
- `KAFKA_TLS_CERT`
- `KAFKA_TLS_KEY`
- `KAFKA_TLS_CA`
- `OPENCLAW_WEBHOOK_URL`
- `OPENCLAW_WEBHOOK_TOKEN`

Key optional env vars:

- `KAFKA_GROUP_ID` (default: `kafka-openclaw-hook`)
- `KAFKA_TOPICS` (default: `webhooks.github,webhooks.linear`)
- `KAFKA_DLQ_TOPIC` (default: `webhooks.dlq`)
- `CONSUMER_MAX_RETRIES` (default: `5`)
- `CONSUMER_BACKOFF_BASE_SECONDS` (default: `1`)
- `CONSUMER_BACKOFF_MAX_SECONDS` (default: `30`)
- `OPENCLAW_MESSAGE_MAX_BYTES` (default: `4000`)
- `OPENCLAW_HTTP_TIMEOUT_SECONDS` (default: `20`)

## Build and Run

From workspace root:

```bash
cargo run -p kafka-openclaw-hook
```

Run tests:

```bash
cargo test -p kafka-openclaw-hook
```

## Deployment

- Preferred runtime is native binary + systemd, not Docker.
- Unit file: `systemd/kafka-openclaw-hook.service`
- Example env file generated by bootstrap: `deploy/env/kafka-openclaw-hook.env`
